<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"/>
  <title>Elettromeccanica Maranzan_Magazzino (touch)</title>
  <link rel="stylesheet" href="/css/app.css" />
  <!-- PWA / Manifest & iOS meta -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <!-- No indexing for this page -->
  <meta name="robots" content="noindex, nofollow, noarchive">
  <meta name="googlebot" content="noindex, nofollow, noarchive">
</head>
<body class="touch-app">
  <main class="app">
    <!-- Risultati -->
    <section id="results-area" aria-live="polite">
      <div id="top-results" class="block"></div>
      <div id="suggestions" class="block"></div>
    </section>

    <!-- Input + Keypad sticky -->
    <section class="input-zone" role="region" aria-label="Ricerca rapida">
      <div class="input-row">
        <div class="input-container">
          <!-- niente tastiera iOS finchÃ© non premi ABC -->
          <input
            id="codice-input"
            class="code-input"
            type="text"
            inputmode="text"
            placeholder="Codice ricambio/scaffale"
            autocomplete="off"
            autocapitalize="off"
            spellcheck="false"
          />
          <span class="camera-inside" id="camera-button" role="button" aria-label="Scansiona QR" tabindex="0">ðŸ“·</span>
          <input type="file" id="qr-file-input" accept="image/*" capture="environment" style="display:none">
        </div>
      </div>

      <div class="keypad" role="group" aria-label="Tastiera numerica">
        <!-- Riga 1: 0 1 2 3 4 - -->
        <button class="key" data-key="0">0</button>
        <button class="key" data-key="1">1</button>
        <button class="key" data-key="2">2</button>
        <button class="key" data-key="3">3</button>
        <button class="key" data-key="4">4</button>
        <button class="key" data-key="-">-</button>

        <!-- Riga 2: 5 6 7 8 9 âŒ« -->
        <button class="key" data-key="5">5</button>
        <button class="key" data-key="6">6</button>
        <button class="key" data-key="7">7</button>
        <button class="key" data-key="8">8</button>
        <button class="key" data-key="9">9</button>
        <button class="key key-back" data-action="backspace" aria-label="Cancella">âŒ«</button>
      </div>
    </section>
  </main>

</script>
  <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
  <script src="/js/cache-manager.js"></script>
  <script src="/js/magazzino.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      // Forza update del service worker
      navigator.serviceWorker.register('/sw.js', { scope: '/', updateViaCache: 'none' })
        .then(reg => {
          console.log('[SW] Registrato, forzo update...');
          reg.update();

          // Se c'Ã¨ un SW in attesa, attivalo subito
          if (reg.waiting) {
            console.log('[SW] SW in attesa trovato, attivo subito');
            reg.waiting.postMessage('SKIP_WAITING');
          }

          // Listener per nuovo SW
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('[SW] Nuovo SW installato! Ricarica la pagina.');
                // Ricarica automaticamente per attivare nuovo SW
                window.location.reload();
              }
            });
          });
        })
        .catch(console.error);
    }

    // Swipe da sinistra per tornare a /private
    (() => {
      const EDGE_THRESHOLD = 50; // Deve partire entro 50px dal bordo sinistro
      const SWIPE_MIN_DISTANCE = 100; // Deve swipare almeno 100px verso destra
      let startX = 0, startY = 0;
      let isEdgeSwipe = false;

      document.addEventListener('touchstart', (e) => {
        const touch = e.touches[0];
        startX = touch.clientX;
        startY = touch.clientY;

        // Controlla se lo swipe parte dal bordo sinistro
        isEdgeSwipe = startX < EDGE_THRESHOLD;
      }, { passive: true });

      document.addEventListener('touchend', (e) => {
        if (!isEdgeSwipe) return;

        const touch = e.changedTouches[0];
        const endX = touch.clientX;
        const endY = touch.clientY;

        const dx = endX - startX; // Distanza orizzontale
        const dy = Math.abs(endY - startY); // Distanza verticale (assoluta)

        // Swipe verso destra dal bordo sinistro
        if (dx > SWIPE_MIN_DISTANCE && dy < 100) {
          // Vibrazione di conferma
          if (navigator.vibrate) navigator.vibrate(50);

          // Torna a /private
          window.location.href = '/private.html';
        }

        isEdgeSwipe = false;
      }, { passive: true });
    })();
  </script>
</body>
</html>
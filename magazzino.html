<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no"/>
  <title>Elettromeccanica Maranzan_Magazzino (touch)</title>
  <link rel="stylesheet" href="css/magazzino.css" />
  <!-- PWA / Manifest & iOS meta -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <!-- No indexing for this page -->
  <meta name="robots" content="noindex, nofollow, noarchive">
  <meta name="googlebot" content="noindex, nofollow, noarchive">
</head>
<body class="touch-app">

  <!-- Indicatore visivo long-press -->
  <div id="long-press-indicator" class="long-press-indicator"></div>

  <main class="app">
    <!-- Risultati -->
    <section id="results-area" aria-live="polite">
      <div id="top-results" class="block"></div>
      <div id="suggestions" class="block"></div>
    </section>

    <!-- Input + Keypad sticky -->
    <section class="input-zone" role="region" aria-label="Ricerca rapida">
      <div class="input-row">
        <div class="input-container">
          <!-- niente tastiera iOS finchÃ© non premi ABC -->
          <input
            id="codice-input"
            class="code-input"
            type="text"
            inputmode="text"
            placeholder="Codice ricambio/scaffale"
            autocomplete="off"
            autocapitalize="off"
            spellcheck="false"
          />
          <span class="camera-inside" id="camera-button" role="button" aria-label="Scansiona QR" tabindex="0">ðŸ“·</span>
          <input type="file" id="qr-file-input" accept="image/*" capture="environment" style="display:none">
        </div>
      </div>

      <div class="keypad" role="group" aria-label="Tastiera numerica">
        <!-- Riga 1: 0 1 2 3 4 - -->
        <button class="key" data-key="0">0</button>
        <button class="key" data-key="1">1</button>
        <button class="key" data-key="2">2</button>
        <button class="key" data-key="3">3</button>
        <button class="key" data-key="4">4</button>
        <button class="key" data-key="-">-</button>

        <!-- Riga 2: 5 6 7 8 9 âŒ« -->
        <button class="key" data-key="5">5</button>
        <button class="key" data-key="6">6</button>
        <button class="key" data-key="7">7</button>
        <button class="key" data-key="8">8</button>
        <button class="key" data-key="9">9</button>
        <button class="key key-back" data-action="backspace" aria-label="Cancella">âŒ«</button>
      </div>
    </section>
  </main>

</script>
  <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
  <script src="js/magazzino.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js', { scope: '/' })
        .catch(console.error);
    }

    // Long-press gesture per tornare a /private (3 secondi)
    (() => {
      const LONG_PRESS_DURATION = 3000; // 3 secondi
      const indicator = document.getElementById('long-press-indicator');
      let pressTimer = null;
      let startX = 0, startY = 0;
      let isCancelled = false;

      // Funzione per avviare il long-press
      function startPress(e) {
        // Previeni interferenze con input, button, link
        const target = e.target;
        if (target.closest('input, button, a, .key')) return;

        // Salva posizione iniziale
        const touch = e.touches ? e.touches[0] : e;
        startX = touch.clientX;
        startY = touch.clientY;
        isCancelled = false;

        // Mostra indicatore e avvia animazione
        indicator.style.left = startX + 'px';
        indicator.style.top = startY + 'px';
        indicator.classList.add('active');

        // Vibrazione iniziale (se supportato)
        if (navigator.vibrate) navigator.vibrate(50);

        // Avvia timer
        pressTimer = setTimeout(() => {
          if (!isCancelled) {
            // Long-press completato!
            indicator.classList.remove('active');
            indicator.classList.add('complete');

            // Vibrazione di conferma
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

            // Torna a /private dopo breve delay
            setTimeout(() => {
              window.location.href = '/private.html';
            }, 300);
          }
        }, LONG_PRESS_DURATION);
      }

      // Funzione per cancellare il long-press
      function cancelPress(e) {
        if (pressTimer) {
          // Controlla se il dito si Ã¨ mosso troppo (tolleranza 20px)
          if (e.touches || e.changedTouches) {
            const touch = e.changedTouches ? e.changedTouches[0] : e.touches[0];
            const moveX = Math.abs(touch.clientX - startX);
            const moveY = Math.abs(touch.clientY - startY);

            if (moveX > 20 || moveY > 20) {
              isCancelled = true;
            }
          }

          clearTimeout(pressTimer);
          pressTimer = null;
          indicator.classList.remove('active', 'complete');
        }
      }

      // Event listeners per touch
      document.addEventListener('touchstart', startPress, { passive: true });
      document.addEventListener('touchend', cancelPress, { passive: true });
      document.addEventListener('touchmove', cancelPress, { passive: true });
      document.addEventListener('touchcancel', cancelPress, { passive: true });

      // Event listeners per mouse (desktop testing)
      document.addEventListener('mousedown', startPress);
      document.addEventListener('mouseup', cancelPress);
      document.addEventListener('mousemove', (e) => {
        if (pressTimer) {
          const moveX = Math.abs(e.clientX - startX);
          const moveY = Math.abs(e.clientY - startY);
          if (moveX > 20 || moveY > 20) {
            cancelPress(e);
          }
        }
      });
    })();
  </script>
</body>
</html>
# Elettromeccanica Maranzan - PWA Gestionale

## üìã Panoramica

Applicazione web progressiva (PWA) per la gestione di un'officina di elettromeccanica. Il sistema gestisce:
- **Magazzino ricambi** (~1400 articoli)
- **Riparazioni** (schede clienti, attrezzi, stato completamento)

**Stack tecnologico:**
- Frontend: Vanilla JavaScript (no framework), CSS custom, HTML5
- Backend: Google Apps Script + Google Sheets come database
- Deploy: GitHub Pages
- CI/CD: GitHub Actions (aggiornamento automatico CSV)

---

## üéØ Obiettivi Generali

### Performance
- Caricamento istantaneo (<0.1s) per aperture successive
- Cache intelligente con validit√† 15-30 minuti
- Background updates silenziosi per dati freschi
- Riduzione chiamate API del 95% rispetto a versione iniziale

### UX Mobile-First
- Interfaccia touch ottimizzata per tablet/smartphone
- Tastiera numerica custom per input rapido codici
- Swipe gestures per navigazione (swipe da sinistra ‚Üí torna indietro)
- Offline-first: funziona senza connessione fino a 30 minuti
- Spazio ottimizzato per iPhone: padding-top ridotto (6px) per massimizzare area visibile

### Affidabilit√† Dati
- Sincronizzazione automatica tra cache locale e Google Sheets
- Validazione duplicati client-side + server-side
- Aggiornamento immediato cache dopo modifiche
- Consistenza garantita tra inserimenti e ricerche

---

## üèóÔ∏è Architettura Componenti

### Frontend (PWA)

```
/
‚îú‚îÄ‚îÄ index.html              # Homepage
‚îú‚îÄ‚îÄ private.html            # Hub gestionale privato
‚îú‚îÄ‚îÄ manifest.webmanifest    # PWA manifest
‚îú‚îÄ‚îÄ sw.js                   # Service Worker (cache strategies)
‚îÇ
‚îú‚îÄ‚îÄ /html/                  # Pagine applicazione
‚îÇ   ‚îú‚îÄ‚îÄ magazzino.html          # Ricerca ricambi (touch interface)
‚îÇ   ‚îú‚îÄ‚îÄ magazzino-nuovo.html    # Inserimento batch ricambi
‚îÇ   ‚îú‚îÄ‚îÄ magazzino-dettaglio.html # Dettaglio/modifica ricambio
‚îÇ   ‚îú‚îÄ‚îÄ riparazioni-archivio.html # Lista tutte riparazioni
‚îÇ   ‚îú‚îÄ‚îÄ riparazioni-nuovo.html   # Nuova scheda riparazione
‚îÇ   ‚îî‚îÄ‚îÄ riparazioni-dettaglio.html # Dettaglio/modifica riparazione
‚îÇ
‚îú‚îÄ‚îÄ /js/
‚îÇ   ‚îú‚îÄ‚îÄ cache-manager.js        # üîë Gestione centralizzata cache localStorage
‚îÇ   ‚îú‚îÄ‚îÄ magazzino.js            # Logica ricerca magazzino (cache-first)
‚îÇ   ‚îú‚îÄ‚îÄ magazzino-nuovo.js      # Batch insert + aggiornamento cache locale
‚îÇ   ‚îú‚îÄ‚îÄ magazzino-dettaglio.js  # CRUD singolo ricambio
‚îÇ   ‚îú‚îÄ‚îÄ riparazioni-archivio.js # Filtri + ricerca riparazioni
‚îÇ   ‚îú‚îÄ‚îÄ riparazioni-nuovo.js    # Form nuova riparazione + autocomplete clienti
‚îÇ   ‚îî‚îÄ‚îÄ riparazioni-dettaglio.js # Modifica riparazione + navigazione prev/next
‚îÇ
‚îî‚îÄ‚îÄ /css/
    ‚îî‚îÄ‚îÄ app.css             # Stili unificati (dark mode, responsive)
```

### Backend (Google Apps Script)

```
/gs/
‚îú‚îÄ‚îÄ magazzino.gs        # API CRUD ricambi (batchAddRicambi, updateRicambio, deleteRicambio)
‚îú‚îÄ‚îÄ riparazioni.gs      # API CRUD riparazioni + gestione clienti normalizzata
‚îî‚îÄ‚îÄ cartellini.gs       # [Futuro] Generazione PDF cartellini riparazione
```

**Endpoints principali:**
- `getRicambi` - Lista completa magazzino
- `getRicambio` - Singolo ricambio per codice
- `batchAddRicambi` - Inserimento multiplo (transazione atomica)
- `getRiparazioni` - Lista completa riparazioni
- `getNextNumero` - Prossimo numero progressivo (lightweight endpoint)
- `getClienti` - Lista clienti per autocomplete
- `updateRiparazione` - Modifica riparazione esistente

### CI/CD (GitHub Actions)

**Workflow:** `.github/workflows/update-csv.yml`
- Trigger: webhook da Cloudflare Worker
- Azione: scarica Google Sheets ‚Üí genera `magazzino.csv` ‚Üí commit ‚Üí deploy
- Throttle: max 1 esecuzione ogni 10 minuti (evita rate limiting)

---

## üîë Componente Critica: CacheManager

**File:** `/js/cache-manager.js`

Singleton che gestisce cache localStorage con timestamp validation.

**API:**
```javascript
// Recupera dati se cache valida (altrimenti null)
const data = cacheManager.get('magazzino');

// Salva dati con timestamp corrente
cacheManager.set('magazzino', ricambiArray);

// Invalida cache specifica
cacheManager.invalidate('magazzino');

// Debug: stato di tutte le cache
console.log(cacheManager.getStats());
```

**Durate cache configurate:**
- `riparazioni`: 15 minuti (sessioni lavoro)
- `clienti`: 10 minuti (dati stabili)
- `magazzino`: 10 minuti (bilanciamento tra performance e freshness)

**Pattern implementato:**
1. Controlla cache localStorage all'avvio pagina
2. Se valida ‚Üí render istantaneo (0.1s)
3. Background update silenzioso (network-first)
4. Se scaduta/assente ‚Üí fetch API (2-3s)

---

## üì± Use Cases Principali

### UC1: Ricerca Ricambio Rapida

**Attore:** Tecnico in officina con tablet

**Flusso:**
1. Apre `/html/magazzino` (caricamento <0.1s se cache valida)
2. Digita codice parziale usando tastiera touch (es: "12345")
3. Risultati istantanei mentre digita (filter client-side su DATA array)
4. Tocca riga risultato ‚Üí dettaglio con scaffale
5. Swipe da sinistra ‚Üí torna alla ricerca

**Variante - Ricerca per scaffale:**
1. Digita "A01" ‚Üí mostra tutti i pezzi dello scaffale A01
2. Swipe orizzontale destro/sinistro ‚Üí naviga scaffali A01 ‚Üí A02 ‚Üí A03...

**Variante - Aggiornamento manuale:**
1. Dalla cima della pagina, swipe down (pull-to-refresh)
2. Appare indicatore blu "‚Üì Trascina per aggiornare"
3. Rilascia ‚Üí "‚ü≥ Aggiornamento in corso... (Xs)"
4. Polling automatico ogni 10s fino a CSV aggiornato (max 3 min)
5. "‚úì Aggiornato!" ‚Üí dati freschi visibili immediatamente

**Performance target:** <0.1s dall'input al risultato (no API call)

---

### UC2: Inserimento Batch Ricambi

**Attore:** Amministratore aggiorna magazzino da fattura fornitore

**Flusso:**
1. Apre `/html/magazzino-nuovo`
2. Inserisce codice, descrizione, scaffale ‚Üí "Aggiungi alla coda"
3. Validazione duplicati real-time (check cache locale)
4. Ripete per 10-20 ricambi ‚Üí tutti in coda (lista visibile)
5. "Salva tutto" ‚Üí **batch insert** singola chiamata API
6. Toast verde "‚úì 20 ricambi salvati con successo!"
7. **Cache locale aggiornata immediatamente** con nuovi ricambi
8. GitHub Actions triggera workflow (aggiornamento CSV in background)

**Risultato:**
- Ritorna a `/html/magazzino` ‚Üí nuovi ricambi SUBITO visibili (da cache locale)
- Dopo ~2 min workflow GitHub completa ‚Üí CSV aggiornato per altri utenti

**Performance target:**
- Inserimento 20 ricambi: ~2 minuti totali (vs 10 min con insert singoli)
- Visibilit√† immediata: 0.1s (vs 2-3s attesa CSV prima di FASE 3)

---

### UC3: Nuova Riparazione Cliente

**Attore:** Receptionist riceve attrezzo da cliente

**Flusso:**
1. Apre `/html/riparazioni-nuovo`
2. Numero progressivo mostrato immediatamente (es: "25/0042")
3. Seleziona data consegna (default: oggi)
4. Inizia a digitare nome cliente ‚Üí **autocomplete** (cache 10 min)
   - Se cliente esistente ‚Üí auto-compila telefono
   - Se nuovo cliente ‚Üí inserisce telefono manualmente
5. Aggiunge attrezzo: marca, dotazione, note
6. Pu√≤ aggiungere pi√π attrezzi (es: "Trapano Makita" + "Smerigliatrice Bosch")
7. "Conferma" ‚Üí popup riepilogo
8. "Salva" ‚Üí API Google Sheets
9. **Cache riparazioni + clienti invalidata** (prossimo accesso ricarica dati freschi)
10. Reload pagina ‚Üí pronta per prossima scheda

**Performance target:** <1s dall'apertura pagina al form compilabile

---

### UC4: Consultazione Archivio Riparazioni

**Attore:** Tecnico cerca riparazione cliente per aggiornamento stato

**Flusso:**
1. Apre `/html/riparazioni-archivio` (caricamento <0.1s se cache valida)
2. Filtro default: "Tutti" (mostra tutte le riparazioni)
3. Toggle "Da completare" ‚Üí mostra solo riparazioni in corso
4. Ricerca per nome cliente (debounce 300ms, filtro client-side)
5. Tocca riga ‚Üí `/html/riparazioni-dettaglio?numero=25/0042`
6. Visualizza dettaglio completo (cliente, telefono, attrezzi, stato)
7. Navigazione prev/next istantanea (usa cache in memoria, no reload)
8. "Modifica scheda" ‚Üí form pre-compilato
9. Cambia stato "Riparato" ‚Üí salva modifiche
10. **Dati aggiornati localmente** (no API call per reload)
11. Burger menu ‚ò∞ ‚Üí torna ad archivio

**Performance target:**
- Prima apertura archivio: 2-3s (cache scaduta)
- Aperture successive (<15 min): 0.1s istantaneo
- Navigazione prev/next: 0s (no reload)

---

### UC5: Modifica Ricambio Esistente

**Attore:** Amministratore corregge scaffale errato

**Flusso:**
1. Cerca ricambio in `/html/magazzino`
2. Tocca risultato ‚Üí `/html/magazzino-dettaglio?codice=12345-1`
3. "Modifica" ‚Üí form con dati pre-compilati
4. Cambia scaffale da "A01" a "B05"
5. "Conferma" ‚Üí popup riepilogo ‚Üí "Salva"
6. API updateRicambio
7. **Cache magazzino invalidata** (prossimo accesso ricarica CSV aggiornato)
8. Torna a magazzino

**Alternative:**
- "Elimina ricambio" ‚Üí conferma ‚Üí rimuove riga da Google Sheets definitivamente

---

## ‚ö° Ottimizzazioni Implementate

### FASE 1: Riduzione Chiamate API
- Endpoint `getNextNumero` lightweight (50 bytes vs 100KB payload)
- Cache-first per riparazioni-archivio
- Tempo apertura form nuova riparazione: 2.5s ‚Üí 0.2s

### FASE 2: Cache Unificata
- CacheManager centralizzato (elimina 150 righe codice duplicato)
- Invalidazione automatica dopo modifiche
- Consistenza dati garantita tra pagine diverse

### FASE 3: Magazzino Cache-First (CRITICO)
- Pattern cache-first per magazzino (allineato a riparazioni)
- Durate cache strategiche (10 min per magazzino)
- **Aggiornamento locale cache dopo batch insert** (fix bug visibilit√†)
- Throttle GitHub Actions: 10 minuti (background)
- **Pull-to-refresh intelligente**:
  - Bypassa throttle (triggera sempre workflow)
  - Polling automatico ogni 10s per verificare aggiornamento CSV
  - Feedback visivo con timer
  - Timeout 3 minuti

**Impatto misurato:**
- Riapertura magazzino dopo 2 min: 2-3s ‚Üí 0.1s (-95%)
- Batch insert + verifica: dati visibili subito (era broken)
- Sessione 30 min (10 aperture): 25s ‚Üí 3.4s (-86%)
- Pull-to-refresh: aggiornamento garantito in ~2 min (tempo workflow)

---

## üîß Service Worker Cache Strategies

**File:** `/sw.js`

**Strategie per risorsa:**

| Risorsa | Strategia | Rationale |
|---------|-----------|-----------|
| `/magazzino.csv` | network-first | Dati freschi prioritari, fallback cache se offline |
| `/html/*.html` | network-first | Aggiornamenti codice immediati |
| `/css/app.css`, `/js/*.js` | network-first | Aggiornamenti codice immediati |
| `/icons/*.png` | cache-first | Icone statiche, performance |
| Navigazioni | network ‚Üí cache ‚Üí shell fallback | Resilienza offline |

**Versione cache attuale:** `em-maranzan-v26`

**Note:**
- Bump versione cache quando modifichi CSS/JS per forzare invalidazione
- CSS e JS usano cache busting con query parameters (?v=X) in HTML
- Service Worker si auto-aggiorna in background (non serve hard refresh utente)
- Hard refresh (Cmd+Shift+R) per debug durante sviluppo

---

## üö® Problemi Comuni e Soluzioni

### Problema: "Modifiche JS/CSS non visibili dopo deploy"
**Causa:** Service Worker serve vecchia versione JS/CSS da cache
**Soluzione:**
1. Bump `CACHE_NAME` in `sw.js` (es: v25 ‚Üí v26)
2. Bump query parameter in HTML:
   - CSS: `<link href="/css/app.css?v=24">` (es: v23 ‚Üí v24)
   - JS: `<script src="/js/magazzino.js?v=23">` (es: v22 ‚Üí v23)
3. Aggiorna PRECACHE_URLS nel SW con nuova versione CSS
4. Commit e push
5. La PWA si auto-aggiorna e ricarica automaticamente alla prossima apertura

**Nota:** Il sistema ora include auto-reload del SW, non serve hard refresh manuale. CSS e JS **devono avere** cache busting per funzionare correttamente su iOS PWA.

### Problema: "Ricambi non visibili dopo batch insert"
**Causa:** Cache magazzino invalidata invece di aggiornata (bug pre-FASE 3)
**Soluzione:** FASE 3 implementata - ora cache locale viene aggiornata immediatamente

### Problema: "GitHub workflow run failed"
**Causa:** Troppi trigger ravvicinati (rate limiting)
**Soluzione:** Throttle 10 minuti implementato - max 6 trigger/ora

### Problema: "Modifiche su Google Sheets non visibili subito"
**Causa:** Cache valida (10 min) + workflow GitHub in corso (~2 min)
**Soluzione:**
1. Swipe down dalla cima (pull-to-refresh)
2. Attendi indicatore "‚ü≥ Aggiornamento in corso... (Xs)"
3. Quando appare "‚úì Aggiornato!" ‚Üí dati freschi visibili
4. Se timeout (3 min) ‚Üí riprova o aspetta che workflow completi

### Problema: "Errore scheda non trovata dopo modifica"
**Causa:** Codice prova a ricaricare da API prima che Google Sheets aggiorni
**Soluzione:** Fix implementato - dati aggiornati localmente senza API reload

### Problema: "CSV serve HTML invece di dati"
**Causa:** Fetch usa path relativo da `/html/` ‚Üí cerca `/html/magazzino.csv`
**Soluzione:** Usa sempre path assoluto `/magazzino.csv`

---

## üìê Best Practices per Future Modifiche

### Quando Modificare Cache Durations
- **Aumenta durata** se i dati cambiano raramente durante sessioni lavoro
- **Diminuisci durata** se serve sincronizzazione frequente tra utenti
- **Attuale:** 10 min magazzino per bilanciare performance e freshness
- **Pull-to-refresh disponibile** per aggiornamenti manuali on-demand

### Pattern Salvataggio Dati
```javascript
// ‚úÖ GIUSTO: Aggiorna cache locale dopo modifica
const result = await apiSave(data);
if (result.success) {
  // Aggiorna cache locale con dati nuovi
  const cached = cacheManager.get('tipo') || [];
  const updated = [...cached, newItem].sort(...);
  cacheManager.set('tipo', updated);
}

// ‚ùå SBAGLIATO: Invalida cache (prossimo accesso lento)
cacheManager.invalidate('tipo');
```

### Aggiungere Nuova Pagina Gestionale
1. Crea `/html/nuova-pagina.html`
2. Crea `/js/nuova-pagina.js`
3. Includi `<script src="/js/cache-manager.js"></script>` prima del tuo JS
4. Usa pattern cache-first nell'init:
   ```javascript
   (async () => {
     const cached = cacheManager.get('tipo');
     if (cached) {
       dati = cached;
       render();
       loadBackground();  // Aggiornamento silenzioso
       return;
     }
     await loadFromAPI();
   })();
   ```
5. Aggiungi link in `/private.html`
6. Aggiungi swipe gesture per tornare a `/private.html`

### Testing Checklist
- [ ] Prima apertura giornata ‚Üí 2-3s (OK, cache vuota)
- [ ] Riapertura <10 min ‚Üí 0.1s istantaneo
- [ ] Riapertura >10 min ‚Üí ricarica CSV aggiornato
- [ ] Pull-to-refresh ‚Üí swipe down ‚Üí ricarica forzato
- [ ] Modifica dati ‚Üí salva ‚Üí cache aggiornata
- [ ] Torna alla lista ‚Üí modifiche visibili subito
- [ ] Console F12 ‚Üí nessun errore rosso
- [ ] Offline ‚Üí funziona con ultimi dati cache
- [ ] Mobile ‚Üí touch responsive, no zoom necessario

---

## üîÆ Roadmap Future Features

### Priorit√† Alta
- [ ] **Cartellini PDF** (gs/cartellini.gs) - Genera PDF scheda riparazione
- [ ] **Statistiche dashboard** - Report mensili riparazioni/magazzino
- [ ] **Notifiche push** - Alert riparazioni completate

### Priorit√† Media
- [ ] **Backup automatico** - Export Google Sheets ‚Üí CSV backup settimanale
- [ ] **Multi-utente sync** - Broadcast updates tra sessioni aperte
- [ ] **Ricerca full-text** - Cerca per descrizione ricambio (non solo codice)

### Priorit√† Bassa
- [ ] **IndexedDB migration** - Sostituisce localStorage (query pi√π veloci)
- [ ] **Fotocamera ricambi** - Salva foto attrezzo in scheda riparazione
- [ ] **Firma digitale cliente** - Canvas signature pad

---

## üìû Contatti Tecnici

**Deploy URL:** https://elettromeccanica-maranzan.com
**Repo GitHub:** marcelloemme/elettromeccanica-maranzan
**Google Apps Script:** Script collegati a Google Sheets privato

**Backup locale:** `/old/` (versione 1.0 pre-refactoring, esclusa da git)

**Nota per Claude:** Puoi sempre fare commit senza chiedere il permesso

---

## üìö File Importanti da Non Toccare

- `/magazzino.csv` - Generato automaticamente da GitHub Actions (non editare manualmente)
- `/.github/workflows/update-csv.yml` - CI/CD workflow (modifica solo se sai cosa fai)
- `/manifest.webmanifest` - PWA config (cambiare `start_url` richiede reinstall app)
- `/gs/*.gs` - Google Apps Script (deploy manuale su Google)

---

**Ultimo aggiornamento:** 2025-01-23 (Ottimizzazioni UX iPhone + CSS cache busting)
